<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>B·∫£n ƒë·ªì GPS ESP32</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
      #map {
        height: 100vh;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <script>
      // ===== V·ªã tr√≠ m·∫∑c ƒë·ªãnh (l√∫c m·ªõi ch·∫°y) =====
      const defaultLatLng = [10.0, 105.0];

      // ===== Kh·ªüi t·∫°o b·∫£n ƒë·ªì =====
      const map = L.map("map").setView(defaultLatLng, 13);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
      }).addTo(map);

      // Danh s√°ch marker hi·ªán t·∫°i tr√™n b·∫£n ƒë·ªì
      let markers = [];

      // B·∫£ng m√†u cho c√°c ƒëi·ªÉm n∆∞·ªõc (xoay v√≤ng)
      const markerColors = [
        "#1d4ed8", // xanh d∆∞∆°ng ƒë·∫≠m
        "#16a34a", // xanh l√°
        "#dc2626", // ƒë·ªè
        "#eab308", // v√†ng
        "#7c3aed", // t√≠m
        "#0d9488", // teal
      ];

      // ===== H√†m c·∫≠p nh·∫≠t v·ªã tr√≠ =====
      async function updatePosition() {
        try {
          const res = await fetch("/gps");
          const data = await res.json();

          // X√≥a t·∫•t c·∫£ marker c≈©
          markers.forEach((m) => map.removeLayer(m));
          markers = [];

          if (Array.isArray(data.points) && data.points.length > 0) {
            let lastPoint = null;

            data.points.forEach((p, index) => {
              if (p.lat === undefined || p.lng === undefined) return;

              const color = markerColors[index % markerColors.length];

              const isLast = index === data.points.length - 1;

              let marker;
              if (isLast) {
                // ƒêi·ªÉm m·ªõi nh·∫•t: d√πng marker icon m·∫∑c ƒë·ªãnh
                marker = L.marker([p.lat, p.lng]).addTo(map);
              } else {
                // C√°c ƒëi·ªÉm tr∆∞·ªõc ƒë√≥: ch·∫•m tr√≤n nh·ªè c√≥ m√†u
                marker = L.circleMarker([p.lat, p.lng], {
                  radius: 6,
                  color: color,
                  fillColor: color,
                  fillOpacity: 0.9,
                  weight: 1,
                }).addTo(map);
              }

              const latStr = Number(p.lat).toFixed(6);
              const lngStr = Number(p.lng).toFixed(6);

              const distStr = Number(p.dist).toFixed(1);

              const rows = `
                <tr><td><b>Lat</b></td><td>${latStr}</td></tr>
                <tr><td><b>Lng</b></td><td>${lngStr}</td></tr>
                <tr><td><b>Kho·∫£ng c√°ch</b></td><td>${distStr} cm</td></tr>
              `;

              const popupHtml = `
                <div style="font-size: 12px;">
                  <table>
                    <tbody>
                      ${rows}
                    </tbody>
                  </table>
                </div>
              `;

              // Popup d·∫°ng b·∫£ng, ch·ªâ hi·ªán khi click
              marker.bindPopup(popupHtml);

              markers.push(marker);
              lastPoint = p;
            });

            // ƒê∆∞a map v·ªÅ ƒëi·ªÉm cu·ªëi c√πng (m·ªõi nh·∫•t)
            if (lastPoint) {
              map.setView([lastPoint.lat, lastPoint.lng]);
            }

            console.log("üì° C√°c ƒëi·ªÉm ƒëang hi·ªÉn th·ªã:", data.points);
          } else {
            // Kh√¥ng c√≥ ƒëi·ªÉm n√†o ‚Üí ƒë∆∞a map v·ªÅ v·ªã tr√≠ m·∫∑c ƒë·ªãnh
            map.setView(defaultLatLng, 13);
            console.log("‚ùå Kh√¥ng c√≥ ƒëi·ªÉm n∆∞·ªõc n√†o trong v√≤ng 1 gi·ªù");
          }
        } catch (err) {
          console.error("‚ö†Ô∏è L·ªói khi c·∫≠p nh·∫≠t:", err);
        }
      }

      // C·∫≠p nh·∫≠t m·ªói 5 gi√¢y
      setInterval(updatePosition, 5000);
    </script>
  </body>
</html>
